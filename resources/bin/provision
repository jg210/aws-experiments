#!/bin/bash

set -o errexit
set -o nounset
set -o pipefail
set -o errtrace
backtrace() {
    local err="$?"
    set +x
    printf "%s\n\n" "*********************************************************************"
    printf "ERROR: %s:%i exited with code: %s\n\n" "${BASH_SOURCE[0]}" "${BASH_LINENO[0]}" "${err}"
    printf "%s\n\n" "${BASH_COMMAND:-}"
    for (( i = 0 ; i < ${#FUNCNAME[@]} - 1 ; i++ )) ; do
	printf "%-50s  %s:%i\n" "${FUNCNAME[$i+1]}()" "${BASH_SOURCE[$i+1]}" "${BASH_LINENO[$i]}"
    done
    exit "${err}"
}
trap 'backtrace' ERR

sudo apt-get -y update
sudo apt-get install -y default-jre
springExperimentsDir=/opt/spring-experiments
sudo mkdir -p "${springExperimentsDir}"
jar="${springExperimentsDir}/spring-experiments.jar"
curl --fail --location https://s3-eu-west-1.amazonaws.com/aws-experiments/artifacts/spring-experiments/spring-experiments-0.0.1-SNAPSHOT.jar | sudo tee "${jar}" > /dev/null
springExperimentsUser=spring-experiments
sudo useradd "${springExperimentsUser}"
systemdUnit=/etc/systemd/system/spring-experiments.service
sudo tee "${systemdUnit}" > /dev/null <<EOF
[Unit]
Description=spring-experiments
After=syslog.target

[Service]
User=${springExperimentsUser}
ExecStart=/usr/bin/java -jar "${jar}"
SuccessExitStatus=143

[Install]
WantedBy=multi-user.target
EOF
sudo systemctl daemon-reload
sudo systemctl enable spring-experiments.service
sudo apt-get -y install nginx
# TODO configure nginx to proxy to spring app.
# TODO restart nginx
